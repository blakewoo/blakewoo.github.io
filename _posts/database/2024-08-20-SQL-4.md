---
title: SQL-4
author: blakewoo
date: 2024-8-21 23:50:00 +0900
categories: [Database]
tags: [Computer science, Database]
render_with_liquid: false
---

### Subquery
쿼리로 걸러낸 데이터를 추가로 쿼리를 통해 걸러내는 중첩 쿼리문이라고 할 수 있다.

- 두 개의 쿼리
  ```sql
  SELECT DEPTNO
  FROM DEPARTMENT
  WHRE COLLEGE = 'Engineering';
  ```
  위 쿼리의 결과인 10과 20을 아래의 쿼리로 처리하는 것
  ```sql
  SELECT SNAME
  FROM STUDENT
  WHERE DEPTNO IN (10,20);
  ```

- Subquery로 하나로 합친 쿼리
  ```sql
  SELECT SNAME
  FROM STUDENT
  WHERE DEPTNO IN 
  (SELECT DEPTNO
  FROM DEPARTMENT
  WHERE COLLEGE = 'Engineering');
  -- 연산 결과가 한 개 일 경우 in 대신 =로 대체 가능
  ```

#### 자주 사용하는 연산자

- any   
  다중 행 연산자로 조건을 만족하는 값이 하나라도 있다면 반환한다.
  
  ```sql
  SELECT SNAME, GRADE, DEPTNO
  FROM STUDENT
  WHERE GRADE > ANY(SELECT GRADE FROM STUDENT WHERE DEPTNO = 40)
  ORDER BY GRADE DESC;
  -- deptno 값이 40인 뭐든 한 개 이상의 레코드의 grade 보다 더 높은 grade를 가진 레코드만 출력
  -- 즉 최소 grade를 가진 레코드보다 더 높은 grade를 가진 레코드만 출력
  ```
  

- all
  다중 행 연산자로 모든 조건을 만족하는 값을 반환한다.
  
  ```sql
  SELECT SNAME, GRADE, DEPTNO
  FROM STUDENT
  WHERE GRADE > ALL (SELECT GRADE FROM STUDENT WHERE DEPTNO = 40)
  ORDER BY GRADE DESC;
  -- deptno 값이 40인 모든 레코드의 모든 grade 보다 더 높은 grade를 가진 레코드만 출력
  ```

- exists
  subquery의 결과 값이 한 개 이상 존재할 경우 true를 반환한다.

  ```sql
  SELECT pname, deptno, major 
  FROM professor p
  WHERE exists (select sid
  from student
  where advisor = p.pid)
  ORDER BY deptno;
  -- advisor 값이 있는 student table의 레코드 값의 panme과 deptno, major 속성을 출력
  ```  


#### 그 외
- 중첩 subquery
  subquery 안에 subquery가 존재할 수 있다.
  ```sql
  SELECT sid, sname, deptno, grade 
  FROM student
  WHERE grade =
  (select max(grade) from student where deptno in
  (select deptno from department
  where college = 'Engineering'));
  -- department table의 college가 'Engineering'인 레코드의 deptno 값을 가져온 것 중에
  -- grade 값이 가장 높은 레코드 값의 sid, sname, deptno, grade를 출력
  ```

- subquery 다중 필드 비교
  subquery는 여러 개의 필드를 대상으로 비교할 수 있다.
  ```sql
  SELECT sname, grade, deptno 
  FROM student
  WHERE (grade, deptno) in
  (select max(grade), deptno from student group by deptno);
  -- student table에서 grade값이 최고값인 레코드를 deptno로 group화하여 sname과 grade, deptno를 출력
  ```

- HAVING 사용
  subquery로 group by를 이용하고 having도 사용이 가능하다.
  ```sql
  SELECT deptno, avg(grade) 
  FROM student
  GROUP BY deptno
  HAVING avg(grade) > (select avg(grade)
  from student
  where deptno = 30);
  -- student table에서 deptno가 30인 레코드의 grade의 평균보다 더 높은 grade를 가진 레코드의 detno와 평균 grade를 출력
  ```


# 참고자료
- [위키백과 - 데이터베이스](https://ko.wikipedia.org/wiki/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4)
- 대학생 시절 강의 자료
- 데이터베이스, 이한출판사, 김경창 외 2명
