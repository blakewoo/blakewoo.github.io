---
title: 컴퓨터 구조 - 병렬 처리 - Cache coherence
author: blakewoo
date: 2025-5-12 21:30:00 +0900
categories: [Computer structure]
tags: [Computer structure, CPU, Multi-processors, Cache] 
render_with_liquid: false
use_math: true
---

# 병렬 처리 - Cache coherence
## 1. 개요
UMA든, NUMA든 각 프로세스나 코어는 캐시를 가진다.   
UMA인지 NUMA인지를 구분하는게 메모리이기 때문이다.   
이 경우 매우 일이 복잡해지는데 각 코어나 프로세스가 가지는 캐시 값을 동기화해주어야하기 때문이다.   
이를 Cache coherence라고 하며 이를 위한 여러가지 방법들이 있다.

## 2. 기본적 접근법
다중 프로세서에서 실행되는 프로그램은 일반적으로 동일한 데이터를 여러 캐시에 복사해 둔다.
별로 드문상황이 아니고 꽤나 자주 일어나는 상황으로 소프트웨어에서 공유를 회피하려 하기보다는,
SMP(Symmetric Multiprocessor) 시스템에서 하드웨어 프로토콜을 사용해 캐시 일관성을 유지한다.

이 경우 아래의 두개가 공유 데이터 성능의 핵심이다.

### 1) 캐시 값 이동
하나의 캐시에서 다른 캐시로 데이터를 옮겨서 사용한다.
원격에 할당된 공유 데이터 접근 시 지연(latency)과 메모리 대역폭 요구를 모두 줄인다.

### 2) 캐시 값 복사
동시에 읽히는 공유 데이터에 대해, 각 캐시가 로컬에 복사본을 만들어서 사용한다.
접근 지연과 읽기 시 발생하는 경쟁(contension)을 모두 줄여준다.

## 3. 캐시 동기화 규약 (Cache Coherence Protocols)

### 1) 스누핑(Snooping)
#### A. 개요
- 데이터를 복사한 모든 캐시는 해당 블록의 공유 상태 정보도 로컬에 보유하되, 중앙집중식 상태 정보는 없다.
- 모든 캐시는 버스나 스위치 같은 브로드캐스트 매체를 통해 서로 접근 가능하다
- 각 캐시 컨트롤러는 매체를 감시(snoop)하여, 버스나 스위치 요청 시 자신이 해당 블록을 가지고 있는지 판단한다.
- 대체적으로 서로 공유하는 회로가 복잡하기 때문에 확장성 면에선 떨어진다.

#### B. 세부 설명
각 데이터를 갖고 있는 캐시의 경우 두 가지의 경우로 서로 Coherence를 맞춰줄 수 있다.   
다른 캐시의 데이터를 Invalid하게 만들기 위해 다른 캐시에 Invalidation을 보내는 방식이거나
혹은, 다른 캐시에 자신의 값을 보내주는 Update 방식이 있다.

### 2) 디렉토리 기반(Directoy based)
#### A. 개요
- 물리 메모리 블록의 공유 상태 정보를 단 하나의 장소(디렉토리)에만 저장이다.
- 브로드캐스트가 아닌 포인트 대 포인트(point-to-point) 통신 방식이다.
- 스누핑에 비하여 확장성(scalability)이 우수한 구조이다.


## 4. 캐시 동기화 세부 설명
### ※ 캐시 상태 정의
캐시 공유 이전에 write back 방식의 캐시 상태는 총 3가지가 있었다.
- Invalid
- valid dirty
- valid non-dirty

위 상태를 아래와 같이 바꿔서 부르기로 정의하고 들어가겠다.
- Invalid
- valid dirty -> Modified, Exclusive
- valid non-dirty -> Shared (잠재적으로 공유되어있을 수 있음)

### 1) write-thru Invalidate
아래와 같은 상황이라고 가정해보자.

![img.png](/assets/blog/cs/parallel/cache_coherence/img.png)

Write-thru 캐시 구조에 Update가 아닌 Invalidate로 Cache 동기화를 하는 구조이다.   
아래의 순서대로 동일한 캐시 slot의 요청이 있다고 해보자.

```
P1 : READ A
P3 : READ A
P3 : WRITE A
P1 : READ A
```
그러면 아래와 같이 작동하게 된다.

- P1 : A:5 값을 메모리에서 갖고옴
- P3 : A:5 값을 메모리에서 갖고옴
- P3 : A를 7로 변경하고 메모리에 반영, 동시에 전체 프로세서들에게 A값을 Invalid 처리하라고 Invalidation을 전송
- P1 : 갖고 있던 A값을 Invalid 처리해버리고, 차후 필요하다면 메모리에서 갖고와서 사용

그림으로 나타내면 아래와 같다.

![img_1.png](/assets/blog/cs/parallel/cache_coherence/img_1.png)

> ※ 추가 업데이트 및 검증 예정이고, 올라간 부분도 아직 완벽하지 않으니 참고만 바란다.
{: .prompt-tip }


# 참고자료
- Computer Organization and Design-The hardware/software interface, 5th edition, Patterson, Hennessy, Elsevier
- 서강대학교 이혁준 교수님 강의자료 - 고급 컴퓨터 구조
