---
title: 쿠버네티스 실습 1 - Nodejs와 Nginx로 리버스 프록시 Pod 만들기
author: blakewoo
date: 2024-4-10 23:45:00 +0900
categories: [Trial and error]
tags: [docker,k8s]
render_with_liquid: false
---

# 개요
nginx conatiner 한 개, nodejs express container 2개 총 3개의 container를
구성한 뒤 1개의 pod에서 구동하여 외부에서 접속 가능한 형태의 간이 서비스를 제작
80으로 접속시 node-1에 접속하여 a-server라는 문구가 뜨게 하고
8080으로 접속시 node-2에 접속하여 b-server라는 문구를 뜨게하는게 목표이다.

환경은 20.04 ubuntu에서 docker와 minikube가 깔려있다는 전제로 진행한다.

# 절차
## minikube 구동
minikube를 구동한 뒤 사용하기 편하도록 alias 처리를 해주고
docker image를 공유할 수 있도록 환경변수 설정을 해준다.
```
minikube start
eval $(minikube -p minikube docker-env)
alias kubectl="minikube kubectl --"
```

## image 만들기
docker를 통해서 container를 총 3개 만든뒤 각각 이미지로 만든다.

- nginx-1
- node-1
- node-2

### nginx-1
먼저 ubuntu 20.04 이미지에 host 네트워크로 container를 구동한다.
```
docker run -i -t --name nginx --net host ubuntu:20.04
```

컨테이너에 접속하자마자 먼저 apt update를 한다
```
apt update
```
이후에 vim과 nginx를 설치한다.
```
apt install -y vim
apt install -y nginx
```
/etc/nginx/conf.d 경로로 가서 server.conf 파일을 만든다
```
vim /etc/nginx/conf.d/server.conf
```
만든 파일에 설정을 아래와 같이 지정한다.
3000번과 3030번으로 들어오되 3000번은 3001번으로 3030번은 3031번으로 요청이 이동한다.
외부로 노출되는 port는 3000과 3030번이된다.
```
server {
        listen   3000;

        access_log  off;

        location / {
                proxy_pass http://127.0.0.1:3001;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Real-IP $remote_addr;
        }
}

server {
        listen   3030;

        access_log  off;

        location / {
                proxy_pass http://127.0.0.1:3031;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Real-IP $remote_addr;
        }
}
```
이후 인스턴스가 실행되면 nginx가 자동 실행되게 설정한다.
```
sudo systemctl start nginx
```

컨트롤 + p + q를 눌러 컨테이너를 나온 뒤 image 작업한 걸 commit 하고 image로 만든다
```
docker commit -a "nginx" nginx nginx
```

### node-1
먼저 ubuntu 20.04 이미지에 host 네트워크로 container를 구동한다.
```
docker run -i -t --name node-1 --net host ubuntu:20.04
```

컨테이너에 접속하자마자 먼저 apt update를 한다
```
apt update
```
이후에 vim와 wget을 설치한다.
```
apt install -y vim
apt install -y wget
```
apt install을 한 후에 node 파일을 받고 사용할 수 있도록 경로를 옮겨준다.
여기서 받을 파일은 nodejs 20.12버전이다
```
wget https://nodejs.org/dist/latest-v20.x/node-v20.12.2-linux-x64.tar.gz
tar -xvf node-v20.12.2-linux-x64.tar.gz
cd node-v20.12.2-linux-x64
cp -r * /usr/local
```
/home에 test폴더를 만들어 들어가서
express generator를 설치후에 ejs를 view-engine으로 myapp 프로젝트를 만든다.
```
npm install -g express-generator
cd /home
mkdir test
express --view=ejs myapp
```
만들어진 myapp 프로젝트에 기본 패키지를 설치하고
접속시에 A-SERVER라는걸 나타나게 기본 페이지를 수정해준다.
```
cd myapp
npm install
cd view
vim index.ejs
```
port도 3000번이 아닌 3001번이 되게 변경해준다.
```
vim /home/test/myapp/bin/www
```

컨트롤 + p + q를 눌러 컨테이너를 나온 뒤 image 작업한 걸 commit 하고 image로 만든다
```
docker commit -a "node-1" node-1 node-1
```

### node-2
node-1 image를 잘 만들었으면 해당 이미지로 container를 만들고 접속한다
```
docker run -i -t --name node-2 --net host node-1
```

myapp경로로 들어가서 port를 3000번에서 3031로 변경해준다.
```
vim /home/test/myapp/bin/www
# 필요한 부분 변경
```
컨트롤 + p + q를 눌러 컨테이너를 나온 뒤 image 작업한 걸 commit 하고 image로 만든다
```
docker commit -a "node-2" node-2 node-2
```


## kubernetes yaml 파일 만들기
원하는 곳에 my-revers-proxy.yaml 파일을 만든다.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-revers-proxy
spec:
  containers:
    - name: nginx
      image: nginx
      imagePullPolicy: Never
      ports:
        - name: a-server
          protocol: TCP
          containerPort: 3000

        - name: b-server
          protocol: TCP
          containerPort: 3030

    - name: node-1
      image: node-1
      imagePullPolicy: Never
      command: ["/bin/sh","-c"]
      args:
        - cd /home;
          cd test;
          cd myapp;
          node bin/www;

    - name: node-2
      image: node-2
      imagePullPolicy: Never
      command: ["/bin/sh","-c"]
      args:
        - cd /home;
          cd test;
          cd myapp;
          node bin/www;
```

## Pod 구동
만든 my-revers-proxy.yaml을 통해 pod를 구동한다.
```
kubectl apply -f my-revers-proxy.yaml
```
구동하고 난 뒤 pod를 살피려면 아래의 명령어를 입력한다
```
kubectl get pods
```
문제가 있는 것 같으면 아래의 명령어로 세세한 상황을 살필 수 있다.
```
kubectl descibe pods my-revers-proxy
```

### Image load가 안되면?
docker에서 만든 image가 로드가 안될 수 있다.
그럴 경우 직접 docker에서 이미지를 추출해서 minikube image에 올려줘야한다.
```
docker save -o nginx.tar nginx
docker save -o node-1.tar node-1
docker save -o node-2.tar node-2

minikube image load nginx.tar
minikube image load node-1.tar
minikube image load node-2.tar
```

## Pod를 사용가능하게 끔 노출
생성한 pod는 구동하는 nginx나 node에 외부에서는 엑세스가 불가능하다.
클러스터 내에서만 접근이 가능한다.
nginx나 node에 접근이 가능하기 위해서는 Pod를 외부에 노출 시켜야한다.


