---
title: 부트로더 - 9
author: blakewoo
date: 2024-2-15 23:05:00 +0900
categories: [OS]
tags: [OS]
render_with_liquid: false
---

사실 이런 코드는 실제로 상용 OS에서 사용되는 코드가 아닌지라 잘 와닿지 않을 수가 있다.
그래서 Ubutnu 최신 버전 (현 시점 기준 6.7 version)에서 사용하는 부트로더인
grub2 코드를 갖고와서 bootloader 부분만 살펴보도록 하겠다.

물론 이 코드를 완전히 다 분석한다고 하면 시간이 엄청 걸릴 뿐더러
GRUB2 코드의 i386 아키텍처에서 boot.S를 이해하는데 첫 줄부터 막혀서 상당히 해맸다.
그래서 계속해서 관련 포스팅을 계속할 것이지만 진도는 매우 느릴 것이라는 점 양해바란다.

일단 가장 친근한 인텔 cpu를 기준으로 보자면
부트를 담당하는 GRUB2 코드는 grub-core/boot/i386/pc/boot.S에 있다.

이 코드를 보면 무언가 이상한 점이 있는데 .S 파일은 어셈블리어 파일로 알고있음에도 불구하고
\#include나 \#define같은 c에서나 쓸법한 문법이 보이는데 이는 gcc에서 어셈블리어로 된 파일을
컴파일 할때 쓰는 확장자로 어셈블리어임에도 불구하고 전처리 기능을 사용할 수 있기에 이렇게 쓰는 것이다.

```
#include <grub/symbol.h>
// 이부분이다
```
해당 헤더 파일을 보면 매크로 함수와 미리 정의된 데이터가 있다.
한데 다음줄을 보면 아래와 같다.
```
#include <grub/machine/boot.h>
```
symbol.h도 include 폴더 안에 있었으니 이것도 동일하겠지 싶어서 찾아보면 그렇지 않다.
include/grub안에 machine이라는 폴더가 없기 때문인데 이는 루트 디렉터리에
configure.ac 파일을 보면 다음과 같이 정의되어있다.

```
AC_CONFIG_LINKS([include/grub/machine:include/grub/$cpudir/$platform])
```

해당 cpu와 플랫폼에 맞는 걸 찾아서 grub/machine 위치에 심볼릭 링크를 걸어주는 식으로 작성되어있기
때문에 해당 위치를 찾을 수 없는 것이며 별도의 설정없이 편리하게 통합하여 코드를 짤 수있는 것이다.

나머지 부분은 다음에 이어서 포스팅하도록 하겠다.


### 참고 문헌
1. https://git.savannah.gnu.org/git/grub.git
